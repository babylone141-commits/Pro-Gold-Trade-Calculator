<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro Gold Trade Calculator (V16 - Suppression de Trade)</title>
<link rel="icon" type="image/png" href="logo.png">
<style>
/* -------------------- GENERAL / LAYOUT -------------------- */
html, body {
    margin: 0;
    padding: 0;
    height: 100%; 
    box-sizing: border-box; 
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    transition: background-color 0.4s, color 0.4s;
}

body {
    display: flex;
    justify-content: center;
    align-items: center; 
    padding: 20px;
    font-size: 0.9em; 
}
body.terminal-mode {
    font-family: 'Consolas', 'Courier New', monospace;
}

.main-layout {
    display: flex;
    gap: 20px; 
    width: 100%;
    max-width: 1500px; 
    height: calc(100vh - 40px); 
}

.container {
    padding: 25px;
    border-radius: 20px; 
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    flex-grow: 1;
    display: flex;
    flex-direction: column; 
    overflow: hidden; 
}

.trade-form-container {
    width: 400px; 
    flex-shrink: 0;
    overflow-y: auto; 
}

.data-column {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 20px; 
}

.results-summary-container {
    display: flex;
    gap: 20px;
    flex-shrink: 0; 
}

.history-container {
    flex-grow: 1; 
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.results-card {
    flex-grow: 1;
    padding: 25px;
    border-radius: 20px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    background-color: #ffffff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
}


h2, h3 {
    text-align: left;
    margin-top: 0;
    margin-bottom: 15px; 
    padding-bottom: 5px;
    color: #1f2937; 
    border-bottom: 1px solid #e5e7eb;
    font-weight: 700; 
    flex-shrink: 0;
}
h2 { font-size: 1.6em; margin-bottom: 18px; } 
h3 { font-size: 1.2em; border-bottom: none; }


/* -------------------- FORM / INPUTS -------------------- */
label {
    display: flex;
    justify-content: space-between; 
    align-items: center;
    margin-top: 8px; 
    font-weight: 500;
    padding: 6px 0; 
    border-bottom: 1px solid #e0e0e0; 
}

#trade-input-section label:last-of-type {
    border-bottom: none; 
}

.label-text {
    display: inline-block;
    width: 150px; 
    flex-shrink: 0;
    text-align: left;
}

input, select {
    padding: 7px 10px; 
    border-radius: 12px; 
    border: 1px solid #d1d5db;
    width: 130px; 
    text-align: right;
    font-family: inherit;
    background-color: #f9fafb;
    color: #1f2937;
    transition: border-color 0.3s, box-shadow 0.3s;
    box-sizing: border-box; 
    font-size: 0.9em; 
}
input:focus, select:focus {
    border-color: #1a75ff; 
    box-shadow: 0 0 0 4px rgba(26, 117, 255, 0.2);
    outline: none;
    background-color: #ffffff;
}


/* -------------------- BUTTONS -------------------- */
.button-group, #trade-buttons-group {
    display: flex;
    gap: 8px; 
    flex-wrap: wrap; 
    margin-top: 20px;
    margin-bottom: 15px;
    flex-shrink: 0;
}

#trade-buttons-group {
    margin-top: 15px;
}

#trade-buttons-group button {
    flex-grow: 1; 
    min-width: 90px; 
    padding: 10px 12px; 
    font-size: 0.9em;
}

button {
    padding: 10px 16px; 
    border-radius: 12px; 
    cursor: pointer;
    font-weight: 600; 
    transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
    border: none;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); 
}

button:active {
    transform: translateY(1px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
}

button.primary { background-color: #1a75ff; color: white; }
button.primary:hover { background-color: #0060e6; }
button.reset { background-color: #ff6b6b; color: white; } 
button.reset:hover { background-color: #e65c5c; }
button.csv { background-color: #4CAF50; color: white; } 
button.csv:hover { background-color: #45a049; }

.theme-toggle {
    position: absolute;
    top: 20px;
    right: 30px;
    width: 45px;
    height: 45px;
    background-color: #f0f2f5;
    color: #1a75ff;
    border-radius: 50%;
    font-size: 1.2em;
    padding: 0;
    border: 2px solid #d1d5db;
    z-index: 50; 
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.theme-toggle:hover { background-color: #e5e7eb; }


/* Style pour le nouveau bouton de suppression dans le tableau */
.delete-btn {
    background-color: #ff3b3b;
    color: white;
    padding: 5px 8px;
    font-size: 0.75em;
    border-radius: 8px;
    box-shadow: none;
    line-height: 1;
}
.delete-btn:hover {
    background-color: #cc0000;
}


/* -------------------- RESULT BOXES & TABLE -------------------- */
.result-box {
    margin-top: 5px; 
    padding: 18px; 
    border-radius: 15px; 
    font-weight: 600;
    border-left: 5px solid #1a75ff; 
    line-height: 1.6;
    background-color: #f7faff; 
    color: #1f2937; 
    font-size: 0.95em;
    max-height: 200px; 
    box-shadow: inset 0 0 5px rgba(26, 117, 255, 0.1); 
}
.result-box strong { color: #1a75ff; }

.table-wrapper {
    flex-grow: 1; 
    overflow-y: auto; 
    border-radius: 15px; 
    border: 1px solid #e0e0e0; 
    background-color: #ffffff;
}

th, td {
    padding: 10px 8px; 
    text-align: center;
    border-bottom: 1px solid #f3f4f6;
    border-right: 1px solid #f3f4f6;
    font-size: 0.85em; 
}

thead th {
    background-color: #f0f2f5; 
    color: #333;
    font-weight: 700;
    border-top-left-radius: 15px; 
    border-top-right-radius: 15px;
}
tbody tr:hover { 
    background-color: #e6f0ff; 
}


/* -------------------- COLORS & THEMES -------------------- */
.red { color: #ff3b3b; font-weight: 700; } 
.green { color: #2ecc71; font-weight: 700; } 
.rr-good { color: #2ecc71; } .rr-ok { color: #f39c12; } .rr-bad { color: #ff3b3b; }

/* --- GEOMETRIC DARK --- */
body.dark-mode { background-color: #1a1a2e; color: #e0e0e0; }
.dark-mode .container, .dark-mode .results-card { background-color: #252a41; }
.dark-mode h2, .dark-mode h3 { color: #f0f0f0; border-bottom-color: #3f4769; }
.dark-mode label { border-bottom-color: #3f4769; }
.dark-mode input, .dark-mode select { border-color: #3f4769; background-color: #1a1a2e; color: #e0e0e0; }
.dark-mode .result-box { background-color: #1a3a5e; border-left-color: #60a5fa; color: #f0f0f0; }
.dark-mode thead th { background-color: #1a1a2e; color: #9ca3af; border-color: #3f4769; }
.dark-mode th, .dark-mode td { border-color: #3f4769; }
.dark-mode tbody tr:hover { background-color: #3f4769; }
.dark-mode .delete-btn { background-color: #ff6b6b; }
.dark-mode .delete-btn:hover { background-color: #e65c5c; }

/* --- NEO-TERMINAL MODE --- */
.terminal-mode { font-weight: 500; }
.terminal-mode .container, .terminal-mode .results-card { border: 1px solid #00ffcc; }

</style>
</head>
<body class="light-mode"> 
<button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle-button">
    ☀️
</button>

<div class="main-layout">
    
    <div class="container trade-form-container">
        <h2>Trade Calculator</h2>
        
        <div style="margin-bottom: 5px; flex-shrink: 0;">
            <label for="theme-selector" style="border: none; padding: 0;">
                <span class="label-text" style="width: 100px;">Theme:</span>
                <select id="theme-selector" onchange="setTheme(this.value)" style="width: 130px; text-align: left; padding: 4px;">
                    <option value="light">Geometric Light</option>
                    <option value="dark">Geometric Dark</option>
                    <option value="terminal">Neo-Terminal</option>
                </select>
            </label>
        </div>

        <h3>Capital & Share</h3>
        <label>
            <span class="label-text" style="width: 150px;">Initial Balance ($):</span>
            <input type="number" id="balance" value="50000" onchange="updateTable()">
        </label>
        <label>
            <span class="label-text" style="width: 150px;">Profit Share (%):</span>
            <input type="number" id="profitShare" value="90">
        </label>
        <div class="button-group">
            <button class="primary" onclick="updateProfitShare()">Update P. Share</button>
        </div>
        
        <h3>New Trade Parameters</h3>
        <div id="trade-input-section"> 
            <label>
                <span class="label-text">Date:</span>
                <input type="date" id="tradeDate" value="">
            </label>
            <label>
                <span class="label-text">Direction:</span>
                <select id="tradeType">
                    <option value="buy">Buy (Long)</option>
                    <option value="sell">Sell (Short)</option>
                </select>
            </label>
            <label>
                <span class="label-text">Entry Price:</span>
                <input type="number" id="entryPrice" step="0.01" value="4250.00">
            </label>
            <label>
                <span class="label-text">Stop Loss (SL):</span>
                <input type="number" id="slPrice" step="0.01" value="4245.00">
            </label>
            <label>
                <span class="label-text">Take Profit (TP):</span>
                <input type="number" id="tpPrice" step="0.01" value="4260.00">
            </label>
            <label>
                <span class="label-text">Risk (%):</span>
                <input type="number" id="riskPercent" step="0.01" value="0.5">
            </label>
        </div>
        
        <h3 style="margin-top: 5px; margin-bottom: 5px;">Trade Outcome</h3>
        <label style="border-bottom: none;">
            <span class="label-text">Outcome:</span>
            <select id="tradeOutcome">
                <option value="TP">TP Hit (Gain)</option>
                <option value="SL">SL Hit (Perte)</option>
                <option value="BE">Breakeven (Point Mort)</option>
            </select>
        </label>
        
        <div id="trade-buttons-group">
            <button class="primary" onclick="calculateOnly()">Calculate</button>
            <button class="primary" onclick="addTrade()">Add Trade</button>
            <button class="reset" onclick="resetTrades()">Reset All</button>
            <button class="csv" onclick="exportCSV()">Export CSV</button>
        </div>
        
    </div>
    
    <div class="data-column">
        
        <div class="results-summary-container">
            
            <div class="results-card" style="flex: 1 1 50%;">
                <h3>Calculation Details</h3>
                <div class="result-box" id="calculatedResult" style="flex-grow: 1; margin-top: 0;">
                    <strong>Calculation Details:</strong>
                    <p style="font-weight: normal; margin: 0;">Enter trade details and click 'Calculate'.</p>
                </div>
            </div>

            <div class="results-card" style="flex: 1 1 50%;">
                <h3>Summary</h3>
                <div class="result-box" id="summary" style="flex-grow: 1; margin-top: 0;">
                    <strong>Account Summary:</strong><br>
                    Initial Balance: $50,000.00<br>
                    Current Balance: $50,000.00<br>
                    Total Realized P.: $0.00<br>
                    Total Net P.: $0.00
                </div>
            </div>

        </div>

        <div class="container history-container" style="padding: 25px; margin-top: 0;">
            <h3>Trade History</h3>
            
            <div class="table-wrapper">
                <table id="tradesTable">
                <thead>
                <tr>
                <th>#</th>
                <th>Date</th>
                <th>Type</th>
                <th>Entry</th>
                <th>SL</th>
                <th>TP</th>
                <th>Lot</th>
                <th>Pot. Profit</th>
                <th>Pot. Loss</th>
                <th>Realized P.</th>
                <th>Net P.</th>
                <th>Current Balance</th>
                <th>Action</th>
                </tr>
                </thead>
                <tbody></tbody>
                </table>
            </div>
        </div>

    </div>

</div>

<script>
let trades = [];
let lastCalculated = {};
let balanceInitial = parseFloat(document.getElementById('balance').value);
const body = document.body;
const themeToggleButton = document.getElementById('theme-toggle-button');
const themeSelector = document.getElementById('theme-selector');


// --- THEME MANAGEMENT ---
function getThemeClass(theme) {
    if (theme === 'dark') return 'dark-mode';
    if (theme === 'terminal') return 'terminal-mode';
    return 'light-mode'; 
}

function updateThemeButton(theme) {
    if (theme === 'dark') {
        themeToggleButton.textContent = '🌑';
    } else if (theme === 'terminal') {
        themeToggleButton.textContent = '🖥️';
    } else {
        themeToggleButton.textContent = '☀️'; 
    }
}

function setTheme(theme) {
    body.classList.remove('light-mode', 'dark-mode', 'terminal-mode');
    body.classList.add(getThemeClass(theme));
    localStorage.setItem('theme', theme);
    themeSelector.value = theme;
    updateThemeButton(theme);
}

function applySavedTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light'; 
    setTheme(savedTheme);
}

function toggleTheme() {
    const currentTheme = localStorage.getItem('theme') || 'light';
    let newTheme = 'light';
    
    if (currentTheme === 'light') {
        newTheme = 'dark';
    } else if (currentTheme === 'dark') {
        newTheme = 'terminal';
    } else { 
        newTheme = 'light';
    }
    setTheme(newTheme);
}
// ------------------------

window.onload = function() {
    applySavedTheme();

    document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
    
    // Assure la mise à jour du solde initial lors du chargement
    balanceInitial = parseFloat(document.getElementById('balance').value);
    const saved = localStorage.getItem('trades');
    if(saved){
        trades = JSON.parse(saved);
        updateTable();
    }
}

function updateProfitShare() {
    const profitShare = parseFloat(document.getElementById('profitShare').value)/100;
    
    // Recalcule le profit net pour les trades existants
    trades.forEach(t => { 
         t.profitNet = t.profitReel * profitShare; 
    });

    // Recalcule le profit net pour la dernière simulation (si elle existe)
    if(lastCalculated.profitReel !== undefined) {
        lastCalculated.profitNet = lastCalculated.profitReel * profitShare;
        document.getElementById("calculatedResult").innerHTML = renderResult(lastCalculated);
    }
    updateTable();
}

function calculateOnly() {
    const balance = trades.length ? trades[trades.length-1].balanceActuelle : balanceInitial;
    const type = document.getElementById('tradeType').value;
    const entry = parseFloat(document.getElementById('entryPrice').value);
    const sl = parseFloat(document.getElementById('slPrice').value);
    const tp = parseFloat(document.getElementById('tpPrice').value);
    const riskPercent = parseFloat(document.getElementById('riskPercent').value)/100;
    const date = document.getElementById('tradeDate').value || new Date().toISOString().split('T')[0];
    const profitShare = parseFloat(document.getElementById('profitShare').value)/100;

    if(isNaN(entry) || isNaN(sl) || isNaN(tp) || isNaN(riskPercent)) {
        document.getElementById("calculatedResult").innerHTML = '<span class="red">Error: Please fill all trade fields.</span>';
        return;
    }

    let slDiff, tpDiff;
    let error = false;

    if(type==="buy") { 
        slDiff = Math.abs(entry - sl); 
        tpDiff = tp - entry; 
        if(sl >= entry || tp <= entry) error = true;
    } else { // sell
        slDiff = Math.abs(sl - entry); 
        tpDiff = entry - tp; 
        if(sl <= entry || tp >= entry) error = true;
    }
    
    if(error) {
        document.getElementById("calculatedResult").innerHTML = '<span class="red">Error: SL or TP is illogical for the chosen direction.</span>';
        return;
    }
    if(slDiff <= 0) {
        document.getElementById("calculatedResult").innerHTML = '<span class="red">Error: SL must be different from Entry Price.</span>';
        return;
    }

    // Lot calculation
    let lot = (balance * riskPercent)/(slDiff*100);
    lot = Math.floor(lot*100)/100; 

    if(lot < 0.01) {
        document.getElementById("calculatedResult").innerHTML = '<span class="red">Warning: Calculated Lot Size is less than 0.01. Increase risk or decrease SL.</span>';
        lastCalculated = {};
        return;
    }

    const potentialProfit = lot*tpDiff*100;
    const potentialLoss = lot*slDiff*100;
    
    // Simule le résultat pour l'affichage de "Calculate Only"
    const outcome = document.getElementById('tradeOutcome').value;
    let profitReelSimulated = potentialProfit; 

    if (outcome === 'SL') {
        profitReelSimulated = -potentialLoss;
    } else if (outcome === 'BE') {
        profitReelSimulated = 0;
    }

    const profitNetSimulated = profitReelSimulated * profitShare;

    lastCalculated = {
        date, type, entry, sl, tp, lot, 
        potentialProfit, potentialLoss,
        profitReel: profitReelSimulated, 
        profitNet: profitNetSimulated 
    };
    document.getElementById("calculatedResult").innerHTML = renderResult(lastCalculated);
}

function renderResult(calc) {
    const rrRatio = (calc.potentialProfit/calc.potentialLoss).toFixed(2);
    let rrClass = 'rr-bad';
    if(rrRatio >= 2) rrClass = 'rr-good';
    else if(rrRatio >= 1) rrClass = 'rr-ok';
    
    const profitColor = calc.profitReel >= 0 ? 'green' : 'red';
    
    return `
        <strong>Calculation Details:</strong><br>
        Date: ${calc.date}<br>
        Type: ${calc.type.toUpperCase()}<br>
        <span class="${calc.lot >= 0.01 ? 'green' : 'red'}">Lot (MT5): ${calc.lot.toFixed(2)}</span><br>
        <span class="green">Pot. Profit: $${calc.potentialProfit.toFixed(2)}</span><br>
        <span class="red">Pot. Loss: $${calc.potentialLoss.toFixed(2)}</span><br>
        <span class="${rrClass}">R/R Ratio: ${rrRatio}</span><br>
        <span class="${profitColor}">Net P. (Simulated): $${calc.profitNet.toFixed(2)}</span>
    `;
}

function addTrade() {
    if(!lastCalculated.lot) { alert("Please calculate a valid trade first before adding it."); return; }
    
    const outcome = document.getElementById('tradeOutcome').value;

    let profitReel;
    let potentialLoss = lastCalculated.potentialLoss; 
    let potentialProfit = lastCalculated.potentialProfit; 

    if (outcome === 'TP') {
        profitReel = potentialProfit;
    } else if (outcome === 'SL') {
        profitReel = -potentialLoss; 
    } else { // BE
        profitReel = 0;
    }
    
    const profitShare = parseFloat(document.getElementById('profitShare').value)/100;
    let profitNet = profitReel * profitShare;
    
    // Le solde actuel sera recalculé par updateTable, donc on n'a besoin que du profit
    
    let newTrade = {...lastCalculated};
    newTrade.profit = potentialProfit; 
    newTrade.potentialLoss = potentialLoss; 
    
    newTrade.profitReel = profitReel; 
    newTrade.profitNet = profitNet; 
    // newTrade.balanceActuelle sera mis à jour dans updateTable
    
    trades.push(newTrade);
    localStorage.setItem('trades', JSON.stringify(trades));
    updateTable();
    lastCalculated = {};
    document.getElementById("calculatedResult").innerHTML = `<span class="green">Trade added successfully!</span>`;
}

// NOUVELLE FONCTION : Supprime un trade à un index donné
function deleteTrade(index) {
    if(confirm(`Are you sure you want to delete trade #${index + 1}? This will affect all subsequent balances.`)) {
        // Supprime l'élément du tableau 'trades' à l'index spécifié
        trades.splice(index, 1); 
        localStorage.setItem('trades', JSON.stringify(trades));
        
        // Recalcule et rafraîchit le tableau et le résumé
        updateTable(); 
    }
}


function updateTable() {
    const tbody = document.querySelector("#tradesTable tbody");
    tbody.innerHTML = "";
    let totalProfit = 0, totalProfitNet = 0;
    
    // Récupère la balance initiale depuis le champ de saisie
    balanceInitial = parseFloat(document.getElementById('balance').value);
    let currentBalance = balanceInitial; 
    
    trades.forEach((t,i)=>{
        const profitShare = parseFloat(document.getElementById('profitShare').value)/100;
        
        // Assure que le profit réel et net est bien là 
        t.profitReel = t.profitReel || t.profit; 
        t.profitNet = t.profitReel * profitShare;
        
        // Mise à jour du solde basé sur le trade actuel
        currentBalance += t.profitReel; 
        t.balanceActuelle = currentBalance;
        
        tbody.innerHTML += `<tr>
            <td>${i+1}</td><td>${t.date}</td><td>${t.type.toUpperCase()}</td>
            <td>${t.entry}</td><td>${t.sl}</td><td>${t.tp}</td>
            <td>${t.lot.toFixed(2)}</td>
            <td>$${(t.profit || t.potentialProfit).toFixed(2)}</td>
            <td>$${(t.potentialLoss).toFixed(2)}</td>
            <td class="${t.profitReel >= 0 ? 'green' : 'red'}">$${t.profitReel.toFixed(2)}</td>
            <td class="${t.profitNet >= 0 ? 'green' : 'red'}">$${t.profitNet.toFixed(2)}</td>
            <td>$${t.balanceActuelle.toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteTrade(${i})">X</button></td>
        </tr>`;
        totalProfit += t.profitReel; 
        totalProfitNet += t.profitNet;
    });
    
    let finalBalance = trades.length ? trades[trades.length-1].balanceActuelle : balanceInitial;
    
    document.getElementById("summary").innerHTML = `
        <strong>Account Summary:</strong><br>
        Initial Balance: $${balanceInitial.toFixed(2)}<br>
        Current Balance: <span class="${finalBalance >= balanceInitial ? 'green' : 'red'}">$${finalBalance.toFixed(2)}</span><br>
        Total Realized P.: $${totalProfit.toFixed(2)}<br>
        Total Net P.: $${totalProfitNet.toFixed(2)}
    `;
    
    localStorage.setItem('trades', JSON.stringify(trades));
}

function resetTrades() {
    if(confirm("WARNING: This will permanently delete all trade history and clear local storage. Continue?")) {
        trades = [];
        localStorage.removeItem('trades');
        balanceInitial = parseFloat(document.getElementById('balance').value);
        updateTable();
        document.getElementById("calculatedResult").innerHTML = "History cleared.";
    }
}

function exportCSV() {
    if(trades.length===0){ alert("No trades to export."); return; }
    let csv = "Date,Type,Entry,SL,TP,Lot,Pot. Profit,Pot. Loss,Realized P.,Net P.,Current Balance\n";
    trades.forEach(t=>{
        csv += `${t.date},${t.type.toUpperCase()},${t.entry},${t.sl},${t.tp},${t.lot.toFixed(2)},${(t.profit || t.potentialProfit).toFixed(2)},${(t.potentialLoss).toFixed(2)},${t.profitReel.toFixed(2)},${t.profitNet.toFixed(2)},${t.balanceActuelle.toFixed(2)}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `trades_gold_export.csv`; a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>